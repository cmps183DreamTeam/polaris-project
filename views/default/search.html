<html>
    <head>
        <title>Search</title>
        <link href = "{{=URL('static','css/global.css')}}" type ="text/css" rel="stylesheet">
        <script src="{{=URL('static', 'js/vue.js')}}"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>


        <!-- Sources for D3 table -->
        <script src="{{=URL('static', 'js/makeTable.js')}}"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="https://cdn.datatables.net/1.10.9/js/jquery.dataTables.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.9/css/jquery.dataTables.min.css">

        <!-- Star Map -->
        <link href = "{{=URL('static','css/star_map.css')}}" type ="text/css" rel="stylesheet">


        <!-- One page website -->
        <link href = "{{=URL('static','css/jquery.fullPage.css')}}" rel="stylesheet" type="text/css">
        <script src="{{=URL('static', 'js/jquery.easings.min.js')}}"></script>
        <script src="{{=URL('static', 'js/jquery.fullPage.min.js')}}"></script>

        <!-- One page script function -->
        <script>
            $(document).ready(function()
            {
                $('#fullpage').fullpage({
                    sectionsColor: ['#f2f2f2', '#4BBFC3', '#7BAABE', 'whitesmoke', '#000'],
                });
            });
        </script>

        <script>
            var posts_url = "{{=URL('default', 'get_posts')}}";
            var add_post_url = "{{=URL('default', 'add_post', user_signature=True)}}";
            var edit_post_url = "{{=URL('default', 'edit_post', user_signature=True)}}";
            var del_post_url = "{{=URL('default', 'del_post', user_signature=True)}}";
        </script>
    </head>

    <body>
        <div id="fullpage">
            <div class="section">

                <a class="back-button" href="{{=URL('default','index')}}">Back</a>

                <div id='container'></div>
                <div id='highlighted'>Nothing Highlighted</div>
                <div id='selected'>Nothing Selected</div>


                <script>
                    var json_str = '{{=XML(json_dict)}}';

                    console.log(json_str);


                    var arr = JSON.parse(json_str);
                    console.log(arr);


                    var table_plot = makeTable()
                      .datum(arr)
                      .sortBy('mag', true)

                    d3.select('#container').call(table_plot);

                    table_plot.on('highlight', function(data, on_off)
                    {
                      if(on_off)
                      {
                          //if the data is highlighted
                           d3.select('#highlighted').text('Mouse on row '  + data.GeneID);
                      }
                    });

                    table_plot.on('select', function(data, on_off)
                    {
                      if(on_off)
                      {
                          //if the data is highlighted
                        d3.select('#selected').text(
                          'Last clicked row was ' + data.GeneID
                        );
                      }
                    });

                </script>


            </div>




            <div class="section">

                <a class="back-button" href="{{=URL('default','index')}}">Back</a>

                <div id="input-form" class="form-modal">
                    <form enctype="multipart/form-data" method="POST" action="{{= URL('default', 'search')}}">
                        <input class="input" type="text" name="name" placeholder="Target Name:{{=reqs.name}}">
                        <input class="input" type="text" name="ra" placeholder=RA:{{=reqs.ra}}>
                        <input class="input" type="text" name="dec" placeholder="DEC:{{=reqs.dec}}">
                        <input class="input" type="text" name="rad" placeholder="Radius:{{=reqs.rad}}"/>

                        <select class="input" name="cat">
                            <option disabled="disabled" selected>Catalog...</option>
                            <option value="USNO-B1">USNO-B1</option>
                            <option value="GSC">GSC</option>
                            <option value="NOMAD">NOMAD</option>
                            <option value="UCAC">UCAC</option>
                        </select>
                        <input class="button" type="submit" value="Submit">
                    </form>
                </div>
            </div>

            <!--                    Star Map                   -->
            <div class="section">
                <script>
                    var width = 960,
                    height = 960,
                    scale = width * 0.45;

                    var radius = d3.scale.linear()
                        .domain([-1, 6])
                        .range([8, 0]);

                    var projection = d3.geo.projection(flippedStereographic)
                        .scale(scale)
                        .clipAngle(130)
                        .rotate([0, -90])
                        .translate([width / 2, height / 2])
                        .precision(0.1);

                    var path = d3.geo.path()
                        .projection(projection);

                    var svg = d3.select("body").append("svg")
                        .attr("width", width)
                        .attr("height", height)
                      .append("g")
                        .attr("transform", "translate(0.5,0.5)");

                    svg.append("path")
                        .datum(d3.geo.circle().origin([0, 90]).angle(90))
                        .attr("class", "horizon")
                        .attr("d", path);

                    svg.append("path")
                        .datum(d3.geo.graticule().minorStep([15, 10]))
                        .attr("class", "graticule")
                        .attr("d", path);

                    var crossDeclination = svg.append("circle")
                        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
                        .attr("class", "cross cross--declination");

                    var crossRightAscension = svg.append("line")
                        .attr("x1", width / 2)
                        .attr("y1", height / 2)
                        .attr("x2", width / 2)
                        .attr("y2", height / 2)
                        .attr("class", "cross cross--right-ascension");

                    var ticksRightAscension = svg.append("g")
                        .attr("class", "ticks ticks--right-ascension");

                    ticksRightAscension.selectAll("line")
                        .data(d3.range(0, 1440, 5)) // every 5 minutes
                      .enter().append("line")
                        .each(function(d) {
                          var p0 = projection([d / 4, 0]),
                              p1 = projection([d / 4, d % 60 ? -1 : -2]);

                          d3.select(this)
                              .attr("x1", p0[0])
                              .attr("y1", p0[1])
                              .attr("x2", p1[0])
                              .attr("y2", p1[1]);
                        });

                    ticksRightAscension.selectAll("text")
                        .data(d3.range(24)) // every hour
                      .enter().append("text")
                        .each(function(d) {
                          var p = projection([d * 15, -4]);

                          d3.select(this)
                              .attr("x", p[0])
                              .attr("y", p[1]);
                        })
                        .attr("dy", ".35em")
                        .text(function(d) { return d + "h"; });

                    svg.append("g")
                        .attr("class", "ticks ticks--declination")
                      .selectAll("text")
                        .data(d3.range(10, 91, 10))
                      .enter().append("text")
                        .each(function(d) {
                          var p = projection([0, d]);

                          d3.select(this)
                              .attr("x", p[0])
                              .attr("y", p[1]);
                        })
                        .attr("dy", ".35em")
                        .text(function(d) { return d + "Â°"; });

                    d3.csv("stars.csv", type, function(error, stars)
                    {
                      if (error) throw error;

                      svg.insert("g", ".ticks")
                          .attr("class", "stars")
                        .selectAll("circle")
                          .data(stars)
                        .enter().append("circle")
                          .attr("id", function(d, i) { return "star-" + i; })
                          .attr("r", function(d) { return radius(d.magnitude); })
                          .attr("transform", function(d) { return "translate(" + d[0] + "," + d[1] + ")"; });

                      svg.append("g")
                          .attr("class", "voronoi")
                        .selectAll("path")
                          .data(d3.geom.voronoi()(stars))
                        .enter().append("path")
                          .on("mouseover", mouseovered)
                          .on("mouseout", mouseouted)
                        .filter(function(d) { return d; })
                          .attr("d", function(d) { return "M" + d.join("L"); })
                          .datum(function(d) { return d.point; })
                        .append("title")
                          .text(function(d) { return "HR" + d.ID + (d.greek_letter || d.constellation ? "\n" + d.constellation + " " + d.greek_letter : ""); });
                    });

                    function mouseovered(d, i) {
                      var dx = d[0] - width / 2,
                          dy = d[1] - height / 2,
                          a = Math.atan2(dy, dx);
                      crossDeclination.attr("r", Math.sqrt(dx * dx + dy * dy));
                      crossRightAscension.attr("x2", width / 2 + width * Math.cos(a)).attr("y2", height / 2 + height * Math.sin(a));
                      console.log(d3.select("#star-" + i).node());
                      d3.select("#star-" + i).classed("star--active", true);
                    }

                    function mouseouted(d, i) {
                      d3.select("#star-" + i).classed("star--active", false);
                    }

                    function type(d) {
                      var p = projection([(+d.RA_hour + d.RA_min / 60 + d.RA_sec / 3600) * 15, +d.dec_deg + d.dec_min / 60 + d.dec_sec / 3600]);
                      d[0] = p[0], d[1] = p[1];
                      d.magnitude = +d.magnitude;
                      return d;
                    }

                    function flippedStereographic(lambda, phi)  {
                      var coslambda = Math.cos(lambda),
                          cosphi = Math.cos(phi),
                          k = 1 / (1 + coslambda * cosphi);
                      return [
                        k * cosphi * Math.sin(lambda),
                        -k * Math.sin(phi)
                      ];
                    }
                </script>
            </div>

        </div>




        <button id="save_query_button" class="button" align="right" href="{{=URL('default','save_query', user_signature=True)}}">Save this query</button>
    </body>
</html>